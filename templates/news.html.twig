{% extends 'base.html.twig' %}

{% block body %}

<div class="flex h-screen w-full">
    {% include 'components/sidebar.html.twig' %}

    <style>
        html, body {
            scroll-behavior: smooth;
        }

        /* Left Part Container */
        .left-part {
            width: 100%;
            max-width: 70%; /* ƒê·ªëi v·ªõi m√†n h√¨nh l·ªõn */
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* ·∫¢nh b√†i vi·∫øt */
        .left-part .article-content img {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 8px; /* Bo g√≥c m·ªÅm m·∫°i */
            margin-bottom: 1rem;
        }

        /* Title Section */
        .left-part .title-section {
            font-size: 2rem; /* Ti√™u ƒë·ªÅ l·ªõn */
            line-height: 1.3;
            color: #1f2937; /* M√†u ƒëen ƒë·∫≠m */
            margin-bottom: -30px;
        }

        /* Description */
        .left-part .body-medium {
            font-size: 1rem; /* C·ª° ch·ªØ c∆° b·∫£n */
            line-height: 1.6;
            color: #374151; /* M√†u x√°m ƒë·∫≠m */
        }

        .left-part .title-small {
            font-size: 1.25rem; /* Ti√™u ƒë·ªÅ nh·ªè */
            line-height: 1.5;
            font-weight: bold;
        }

        /* Article Content */
        .left-part .article-content {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
        }

        .left-part .article-content h1,
        .left-part .article-content h2,
        .left-part .article-content h3,
        .left-part .article-content h4 {
            font-weight: bold;
            margin: 1rem 0;
            font-size: 28px;
        }

        .left-part .article-content p {
            margin-bottom: 1.5rem;
        }

        .left-part .article-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        figure.wp-caption.aligncenter {
            width: auto !important; /* Lo·∫°i b·ªè chi·ªÅu r·ªông c·ªë ƒë·ªãnh */
            max-width: 100%; /* ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° k√≠ch th∆∞·ªõc m√†n h√¨nh */
        }

        table {
            display: block; /* Bi·∫øn b·∫£ng th√†nh kh·ªëi ƒë·ªÉ th√™m cu·ªôn */
            overflow-x: auto; /* Th√™m thanh cu·ªôn ngang */
            white-space: nowrap; /* NgƒÉn ng·∫Øt d√≤ng n·ªôi dung b·∫£ng */
        }

        table th,
        table td {
            border: 1px solid #ddd; /* ƒê∆∞·ªùng vi·ªÅn gi·ªØa c√°c √¥ */
            padding: 15px; /* Kho·∫£ng c√°ch trong √¥ */
            text-align: left; /* CƒÉn ch·ªØ sang tr√°i */
        }

        table::before {
            content: ''; /* T·∫°o ph·∫ßn t·ª≠ gi·∫£ */
            display: block;
            height: 0; /* ƒê·∫£m b·∫£o kh√¥ng ·∫£nh h∆∞·ªüng layout */
        }

        tr:hover {
            background-color: #f1f1f1; /* ƒê·ªïi m√†u h√†ng khi hover */
        }

        tr:nth-child(even) {
            background-color: #f9f9f9; /* M√†u n·ªÅn xen k·∫Ω */
        }

        td {
            transition: background-color 0.3s; /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi m√†u khi hover */
        }
    </style>

    <div class="w-full h-full overflow-y-auto">
        <div class="bg-gray-900 min-h-screen text-white p-6 relative">
            <div class="max-w-3xl mx-auto">
                {# √î ƒëƒÉng tr·∫°ng th√°i #}
                <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-4">
                    <div class="flex items-center space-x-3">
                        <a href="/dashboard/profile/{{ profile.slug }}">
                            <img src="{{ profile.avatar }}" class="w-10 h-10 rounded-full border border-gray-700">
                        </a>
                        <input type="text" placeholder="{{ profile.name }} ∆°i, b·∫°n ƒëang nghƒ© g√¨ th·∫ø?"
                               class="flex-1 bg-gray-700 text-white p-2 rounded-full outline-none placeholder-gray-400 cursor-pointer"
                               id="openModal">
                    </div>
                </div>

                <div id="postModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-[99999]">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-96 relative z-[99999]">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-white text-lg font-semibold">T·∫°o b√†i vi·∫øt</h2>
                            <button id="closeModal" class="text-gray-400 hover:text-white text-xl">‚úñ</button>
                        </div>

                        <!-- Form ƒëƒÉng b√†i -->
                        <form action="{{ path('create_post') }}" method="POST">
            <textarea name="content" id="postContent" class="w-full h-32 p-2 rounded-lg bg-gray-700 text-white"
                      placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>

                            <!-- N√∫t ƒëƒÉng b√†i -->
                            <div class="flex justify-end mt-4">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                    ƒêƒÉng b√†i
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                {# Danh s√°ch b·∫°n b√® #}
                <div class="relative w-full max-w-2xl mx-auto mt-10">
                    <!-- Swiper Container -->
                    <div class="swiper mySwiper">
                        <div class="swiper-wrapper">
                            {# Danh s√°ch b·∫°n b√® #}
                            {% for friend in friendList %}
                                <a href="/dashboard/profile/{{ friend.slug }}" class="swiper-slide relative w-32 h-48 bg-gray-800 rounded-xl overflow-hidden shrink-0">
                                    <img src="{{ friend.avatar }}" class="w-full h-full object-cover">
                                    {# Avatar b·∫°n b√® #}
                                    <div class="absolute top-2 left-2 w-10 h-10 border-4 border-gray-900 rounded-full overflow-hidden">
                                        <img src="{{ friend.avatar }}" class="w-full h-full object-cover">
                                    </div>
                                    {# T√™n b·∫°n b√® #}
                                    <div class="absolute bottom-2 left-2 text-sm font-semibold truncate w-full text-center px-2">
                                        {{ friend.name }}
                                    </div>
                                </a>
                            {% endfor %}
                        </div>

                        <!-- N√∫t b·∫•m tr√°i/ph·∫£i -->
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-button-next"></div>
                    </div>
                </div>

                {# Modal edit b√†i vi·∫øt #}
                <div id="editModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-[99999]">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-96 relative z-[99999]">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-white text-lg font-semibold">Ch·ªânh s·ª≠a b√†i vi·∫øt</h2>
                            <button id="closeEditModal" class="text-gray-400 hover:text-white text-xl">‚úñ</button>
                        </div>

                        <!-- Form ch·ªânh s·ª≠a -->
                        <form id="editForm" method="POST">
                            <textarea name="content" id="editContent" class="w-full h-32 p-2 rounded-lg bg-gray-700 text-white"></textarea>

                            <!-- N√∫t c·∫≠p nh·∫≠t -->
                            <div class="flex justify-end mt-4">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                    C·∫≠p nh·∫≠t b√†i vi·∫øt
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
            {# Danh s√°ch b√†i vi·∫øt #}
            <div class="bg-gray-900 min-h-screen text-white p-6 h-full">
                <div class="max-w-2xl mx-auto">
                    {% for post in posts %}
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
                            {# Header b√†i ƒëƒÉng #}
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <img src="{{ post.avatarAuthor }}" class="w-10 h-10 rounded-full" alt="Avatar c·ªßa {{ post.authorName }}">
                                    <div>
                                        <p class="font-semibold">{{ post.authorName }}</p>
                                        <p class="text-sm text-gray-400">{{ post.createdAt|date('d/m/Y H:i') }} ‚Ä¢ üåç</p>
                                    </div>
                                </div>

                                {# N√∫t ch·ªânh s·ª≠a & x√≥a (Ch·ªâ hi·ªÉn th·ªã n·∫øu l√† t√°c gi·∫£) #}
                                {% if post.idAuthor == profile.userId %}
                                    <div class="flex space-x-2">
                                        <button class="text-blue-400 hover:text-blue-300 transition" onclick="editPost({{ post.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="text-red-400 hover:text-red-300 transition" onclick="deletePost({{ post.id }})">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>

                            {# N·ªôi dung b√†i ƒëƒÉng #}
                            <div class="mt-3 text-gray-300">
                                <p>{{ post.content|raw }}</p>
                            </div>

                            {# L∆∞·ª£t th√≠ch, b√¨nh lu·∫≠n #}
                            <div class="flex justify-between items-center mt-3 text-gray-400 text-sm">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="mr-3">{{ post.likes }} l∆∞·ª£t th√≠ch</span>
                                </div>
                            </div>

                            {# N√∫t t∆∞∆°ng t√°c #}
                            <div class="flex justify-between mt-2 border-t border-gray-600 pt-2">
                                <button class="flex-1 flex items-center justify-center py-2 rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-thumbs-up mr-3"></i> Th√≠ch
                                </button>
                                <button class="flex-1 flex items-center justify-center py-2 rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-comment-alt mr-3"></i> B√¨nh lu·∫≠n
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-center text-gray-400">Kh√¥ng c√≥ b√†i vi·∫øt n√†o.</p>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>


    <!-- Script TinyMCE v√† Modal -->
    <script src="https://cdn.tiny.cloud/1/4ap6sni821pn56o84cses0860nmtuvurlwoxovop0j9t37j5/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Nh√∫ng Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

    <!-- Nh√∫ng Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Swiper Init -->
    <script>
        var swiper = new Swiper(".mySwiper", {
            slidesPerView: 4,   // Hi·ªÉn th·ªã 4 √¥ b·∫°n b√® m·ªói l·∫ßn
            spaceBetween: 15,   // Kho·∫£ng c√°ch gi·ªØa c√°c √¥
            navigation: {       // N√∫t ƒëi·ªÅu h∆∞·ªõng
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
            grabCursor: true,   // Hi·ªáu ·ª©ng b√†n tay khi r√™ chu·ªôt
            loop: false,        // Kh√¥ng l·∫∑p v√¥ h·∫°n
        });
    </script>

{#    Tiny MCE#}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Kh·ªüi t·∫°o TinyMCE
            tinymce.init({
                selector: '#postContent',
                menubar: false,
                plugins: 'autolink lists link image charmap preview',
                toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent',
                skin: "oxide-dark",
                content_css: "dark",
                setup: function (editor) {
                    editor.on('focus', function () {
                        document.getElementById("postModal").classList.add("z-[9999]");
                    });
                }
            });

            // Modal
            const modal = document.getElementById("postModal");
            const openModal = document.getElementById("openModal");
            const closeModal = document.getElementById("closeModal");

            openModal.addEventListener("click", function () {
                modal.classList.remove("hidden");
            });

            closeModal.addEventListener("click", function () {
                modal.classList.add("hidden");
            });

            // ƒê√≥ng modal khi click ra ngo√†i
            modal.addEventListener("click", function (e) {
                if (e.target === modal) {
                    modal.classList.add("hidden");
                }
            });
        });
    </script>

{#    Modal Open/Close#}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("postModal");
            const openModal = document.getElementById("openModal");
            const closeModal = document.getElementById("closeModal");

            openModal.addEventListener("click", function () {
                modal.classList.remove("hidden");
            });

            closeModal.addEventListener("click", function () {
                modal.classList.add("hidden");
            });

            // ƒê√≥ng modal khi click ra ngo√†i
            modal.addEventListener("click", function (e) {
                if (e.target === modal) {
                    modal.classList.add("hidden");
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Modal ch·ªânh s·ª≠a
            const editModal = document.getElementById("editModal");
            const closeEditModal = document.getElementById("closeEditModal");
            const editForm = document.getElementById("editForm");
            let currentPostId = null;

            // H√†m kh·ªüi t·∫°o TinyMCE n·∫øu ch∆∞a c√≥
            function initTinyMCE(callback) {
                if (!tinymce.get('editContent')) {
                    tinymce.init({
                        selector: '#editContent',
                        menubar: false,
                        plugins: 'autolink lists link image charmap preview',
                        toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent',
                        skin: "oxide-dark",
                        content_css: "dark",
                        setup: function (editor) {
                            editor.on('init', function () {
                                console.log("TinyMCE ƒë√£ kh·ªüi t·∫°o");
                                if (callback) callback();
                            });
                        }
                    });
                } else {
                    if (callback) callback();
                }
            }

            // M·ªü modal ch·ªânh s·ª≠a
            function openEditModal(postId, currentContent) {
                currentPostId = postId;
                editForm.action = `/post/edit/${postId}`;

                // ƒê·∫£m b·∫£o TinyMCE ƒë√£ kh·ªüi t·∫°o tr∆∞·ªõc khi set n·ªôi dung
                initTinyMCE(() => {
                    tinymce.get('editContent').setContent(currentContent);
                });

                // Hi·ªÉn th·ªã modal
                editModal.classList.remove("hidden");
            }

            // ƒê√≥ng modal ch·ªânh s·ª≠a
            closeEditModal.addEventListener("click", function () {
                editModal.classList.add("hidden");
            });

            // G·ª≠i request c·∫≠p nh·∫≠t b√†i vi·∫øt
            editForm.addEventListener("submit", function (e) {
                e.preventDefault(); // NgƒÉn ch·∫∑n load l·∫°i trang

                const newContent = tinymce.get('editContent').getContent(); // L·∫•y n·ªôi dung t·ª´ TinyMCE

                fetch(`/post/edit/${currentPostId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ content: newContent }),
                })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        location.reload(); // L√†m m·ªõi trang sau khi ch·ªânh s·ª≠a
                    })
                    .catch(error => console.error("L·ªói:", error));
            });

            // H√†m m·ªü modal ch·ªânh s·ª≠a t·ª´ n√∫t "Ch·ªânh s·ª≠a"
            window.editPost = function (postId) {
                fetch(`/post/${postId}`)
                    .then(response => response.json())
                    .then(data => {
                        openEditModal(postId, data.content);
                    })
                    .catch(error => console.error("L·ªói khi l·∫•y n·ªôi dung b√†i vi·∫øt:", error));
            };
        });

        function deletePost(postId) {
            console.log("ƒêang x√≥a b√†i vi·∫øt c√≥ ID:", postId); // Ki·ªÉm tra s·ª± ki·ªán click

            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?")) return;

            fetch(`/post/delete/${postId}`, {
                method: "DELETE",
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload(); // C·∫≠p nh·∫≠t trang sau khi x√≥a
                })
                .catch(error => console.error("L·ªói:", error));
        }
    </script>

    {# Include Alert Component #}
    {% include 'components/alert.html.twig' %}

{% endblock %}
